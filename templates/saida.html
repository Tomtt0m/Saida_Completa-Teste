<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saída Completa</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
    <h1>Saída Completa</h1>
    <p>Olá, <strong>{{ usuario }}</strong></p>

    <!-- type="button" para não recarregar -->
    <button type="button" id="start-scan">Registrar Palete Completo</button>

    <div id="qr-reader" class="qr-code-container" style="display: none; width: 300px;"></div>

    <form id="form-dados" style="display: none;" enctype="multipart/form-data">
      <input type="hidden" name="registro_id" id="registro_id">

      <label>QR Code:</label>
      <input type="text" id="qr_code_raw" readonly>

      <label>Produto:</label>
      <input type="text" id="produto" required>

      <label>Rota:</label>
      <input type="text" id="rota" readonly>

      <label>Pré-nota:</label>
      <input type="text" id="pre_nota" readonly>

      <label>Região:</label>
      <input type="text" id="regiao_nome" readonly>

      <label>Nº da Caixa:</label>
      <input type="text" id="numero_caixa" readonly>

      <label>Quantidade de Volumes:</label>
      <input type="number" id="quantidade" required>

      <label>Anexar foto da Etiqueta:</label>
      <input type="file" id="foto_etiqueta" accept="image/*" capture="environment">
      <img id="preview_etiqueta" class="preview" style="display:none; max-width: 300px;">

      <label>Anexar foto do Palete:</label>
      <input type="file" id="foto_palete" accept="image/*" capture="environment">
      <img id="preview_palete" class="preview" style="display:none; max-width: 300px;">

      <button type="button" id="confirmar">Confirmar</button>
    </form>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const startScanBtn = document.getElementById("start-scan");
    const qrReader = document.getElementById("qr-reader");
    const formDados = document.getElementById("form-dados");

    const previewEtiqueta = document.getElementById("preview_etiqueta");
    const previewPalete = document.getElementById("preview_palete");

    let scanner;
    let dadosQRCode = null;

    // Função para extrair dados do QR Code
    function extrairDadosQRCode(codigo) {
      const rota = codigo.substring(9, 13);
      const pre_nota = codigo.substring(14, 20);
      const codigo_regiao = codigo.substring(26, 28);
      const numero_caixa = codigo.substring(36, 40);

      return {
        qr_code_raw: codigo,
        rota,
        pre_nota,
        regiao_cod: codigo_regiao,
        regiao_nome: "",
        produto: "",
        numero_caixa,
      };
    }

    // Preenche campos do formulário com os dados
    function preencherFormulario(dados) {
      document.getElementById("qr_code_raw").value = dados.qr_code_raw;
      document.getElementById("produto").value = dados.produto;
      document.getElementById("rota").value = dados.rota;
      document.getElementById("pre_nota").value = dados.pre_nota;
      document.getElementById("regiao_nome").value = dados.regiao_cod;
      document.getElementById("numero_caixa").value = dados.numero_caixa;
    }

    // Iniciar leitura ao clicar no botão
    startScanBtn.addEventListener("click", () => {
      qrReader.style.display = "block";
      scanner = new Html5Qrcode("qr-reader");

      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          console.log("QR Code lido:", qrCodeMessage);
          scanner.stop();
          qrReader.style.display = "none";

          dadosQRCode = extrairDadosQRCode(qrCodeMessage.trim());
          preencherFormulario(dadosQRCode);

          formDados.style.display = "block";
        },
        errorMessage => { /* ignora erros */ }
      ).catch(err => console.error("Erro ao iniciar scanner:", err));
    });

    // Clique no botão confirmar envia dados para o servidor
    document.getElementById("confirmar").addEventListener("click", () => {
      if (!dadosQRCode) {
        alert("Nenhum QR Code lido ainda!");
        return;
      }

      dadosQRCode.produto = document.getElementById("produto").value;
      dadosQRCode.quantidade = document.getElementById("quantidade").value;
      dadosQRCode.regiao_nome = document.getElementById("regiao_nome").value;
      dadosQRCode.numero_caixa = document.getElementById("numero_caixa").value;

      const formData = new FormData();
      for (const key in dadosQRCode) {
        formData.append(key, dadosQRCode[key]);
      }
      formData.append("foto_etiqueta", document.getElementById("foto_etiqueta").files[0]);
      formData.append("foto_palete", document.getElementById("foto_palete").files[0]);

      fetch("/registrar", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "sucesso") {
          alert("Registro enviado com sucesso!");
          window.location.href = "/registros"; // Redireciona após sucesso
        } else {
          alert("Erro: " + data.mensagem);
        }
      })
      .catch(err => {
        console.error("Erro ao enviar:", err);
        alert("Erro ao enviar os dados!");
      });
    });

    // Pré-visualização das fotos
    document.getElementById("foto_etiqueta").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        previewEtiqueta.src = URL.createObjectURL(file);
        previewEtiqueta.style.display = "block";
      }
    });

    document.getElementById("foto_palete").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        previewPalete.src = URL.createObjectURL(file);
        previewPalete.style.display = "block";
      }
    });
  });
  </script>
</body>
</html>
